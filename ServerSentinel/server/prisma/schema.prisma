// ServerSentinel Prisma Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String              @id @default(uuid()) @db.Uuid
  email               String              @unique @db.VarChar(255)
  passwordHash        String              @map("password_hash") @db.VarChar(255)
  role                String              @db.VarChar(50)
  firstName           String?             @map("first_name") @db.VarChar(100)
  lastName            String?             @map("last_name") @db.VarChar(100)
  isActive            Boolean             @default(true) @map("is_active")
  lastLogin           DateTime?           @map("last_login") @db.Timestamptz(6)
  createdAt           DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  refreshTokens       RefreshToken[]
  acknowledgedAlerts  Alert[]             @relation("AcknowledgedBy")
  events              Event[]
  favorites           UserFavorite[]
  pushSubscriptions   PushSubscription[]
  notificationDeliveries NotificationDelivery[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @map("token_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  isRevoked Boolean  @default(false) @map("is_revoked")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Client {
  id              String    @id @default(uuid()) @db.Uuid
  name            String    @db.VarChar(255)
  tokenHash       String    @unique @map("token_hash") @db.VarChar(255)
  hostname        String?   @db.VarChar(255)
  ipAddress       String?   @map("ip_address") @db.Inet
  osType          String?   @map("os_type") @db.VarChar(50)
  osVersion       String?   @map("os_version") @db.VarChar(100)
  agentVersion    String?   @map("agent_version") @db.VarChar(50)
  metadata        Json      @default("{}")
  thresholdCpu    Float?    @default(85.0) @map("threshold_cpu") @db.Real
  thresholdMemory Float?    @default(85.0) @map("threshold_memory") @db.Real
  thresholdDisk   Float?    @default(90.0) @map("threshold_disk") @db.Real
  isActive        Boolean   @default(true) @map("is_active")
  lastSeen        DateTime? @map("last_seen") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  metrics     Metric[]
  alerts      Alert[]
  favorites   UserFavorite[]
  alertRules  AlertRule[]

  @@index([name])
  @@index([isActive])
  @@index([lastSeen])
  @@map("clients")
}

model Metric {
  id             String   @default(uuid()) @db.Uuid
  clientId       String   @map("client_id") @db.Uuid
  metricTime     DateTime @default(now()) @map("metric_time") @db.Timestamptz(6)
  cpuPercent     Float?   @map("cpu_percent") @db.Real
  memoryPercent  Float?   @map("memory_percent") @db.Real
  memoryUsedMb   BigInt?  @map("memory_used_mb")
  memoryTotalMb  BigInt?  @map("memory_total_mb")
  diskPercent    Float?   @map("disk_percent") @db.Real
  diskUsedGb     BigInt?  @map("disk_used_gb")
  diskTotalGb    BigInt?  @map("disk_total_gb")
  diskDetails    Json     @default("[]") @map("disk_details")
  networkRxBytes BigInt?  @map("network_rx_bytes")
  networkTxBytes BigInt?  @map("network_tx_bytes")
  loadAverage    Float[]  @map("load_average")
  processCount   Int?     @map("process_count")
  topProcesses   Json     @default("[]") @map("top_processes")
  additional     Json     @default("{}")
  gpuPercent         Float?  @map("gpu_percent") @db.Real
  gpuMemoryUsedMb    BigInt? @map("gpu_memory_used_mb")
  gpuMemoryTotalMb   BigInt? @map("gpu_memory_total_mb")
  gpuTemperature     Float?  @map("gpu_temperature") @db.Real
  
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@id([id, metricTime])
  @@index([clientId, metricTime(sort: Desc)])
  @@index([metricTime(sort: Desc)])
  @@map("metrics")
}

model Alert {
  id              String    @id @default(uuid()) @db.Uuid
  clientId        String    @map("client_id") @db.Uuid
  metric          String    @db.VarChar(50)
  value           Float     @db.Real
  threshold       Float     @db.Real
  severity        String    @db.VarChar(20)
  status          String    @default("OPEN") @db.VarChar(20)
  title           String?   @db.VarChar(255)
  message         String?   @db.Text
  metadata        Json      @default("{}")
  acknowledgedBy  String?   @map("acknowledged_by") @db.Uuid
  acknowledgedAt  DateTime? @map("acknowledged_at") @db.Timestamptz(6)
  resolvedAt      DateTime? @map("resolved_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  client              Client                 @relation(fields: [clientId], references: [id], onDelete: Cascade)
  acknowledgedByUser  User?                  @relation("AcknowledgedBy", fields: [acknowledgedBy], references: [id])
  notificationDeliveries NotificationDelivery[]

  @@index([clientId])
  @@index([status])
  @@index([severity])
  @@index([createdAt(sort: Desc)])
  @@index([clientId, status, createdAt(sort: Desc)])
  @@map("alerts")
}

model NotificationDelivery {
  id           String    @id @default(uuid()) @db.Uuid
  alertId      String    @map("alert_id") @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  channel      String    @db.VarChar(50)
  status       String    @db.VarChar(20)
  errorMessage String?   @map("error_message") @db.Text
  metadata     Json      @default("{}")
  sentAt       DateTime? @map("sent_at") @db.Timestamptz(6)
  deliveredAt  DateTime? @map("delivered_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  
  alert Alert @relation(fields: [alertId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([alertId])
  @@index([userId])
  @@index([status])
  @@map("notification_deliveries")
}

model PushSubscription {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  endpoint  String   @db.Text
  keys      Json
  userAgent String?  @map("user_agent") @db.Text
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@index([isActive])
  @@map("push_subscriptions")
}

model Event {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String?   @map("user_id") @db.Uuid
  eventType  String    @map("event_type") @db.VarChar(100)
  entityType String?   @map("entity_type") @db.VarChar(100)
  entityId   String?   @map("entity_id") @db.Uuid
  action     String    @db.VarChar(50)
  metadata   Json      @default("{}")
  ipAddress  String?   @map("ip_address") @db.Inet
  userAgent  String?   @map("user_agent") @db.Text
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventType])
  @@index([createdAt(sort: Desc)])
  @@index([entityType, entityId])
  @@map("events")
}

model UserFavorite {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  clientId  String   @map("client_id") @db.Uuid
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([userId, clientId])
  @@index([userId, sortOrder])
  @@map("user_favorites")
}

model AlertRule {
  id               String   @id @default(uuid()) @db.Uuid
  clientId         String?  @map("client_id") @db.Uuid
  name             String   @db.VarChar(255)
  metric           String   @db.VarChar(50)
  operator         String   @db.VarChar(20)
  threshold        Float    @db.Real
  durationSeconds  Int      @default(0) @map("duration_seconds")
  severity         String   @db.VarChar(20)
  isEnabled        Boolean  @default(true) @map("is_enabled")
  cooldownMinutes  Int      @default(10) @map("cooldown_minutes")
  metadata         Json     @default("{}")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  client Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([isEnabled])
  @@map("alert_rules")
}
